Impala C++ код следует модифицированной версии [руководства по стилю C++ от Google](https://google.github.io/styleguide/cppguide.html).

Здесь задокументированы некоторые ключевые отличия.

#### **Заголовочные файлы**

Раздельные заголовочные файлы для `inline`-функций: мы разрешаем размещать `inline`-функции в отдельных файлах с суффиксом `.inline.h`. Это может ускорить время компиляции, уменьшая объем кода, который нужно компилировать, и сокращая зависимости между заголовочными файлами.  
Защита от повторного включения заголовков: для нового кода мы предпочитаем `#pragma once`, так как это более чистый способ по сравнению с классическими  
`#include guards`.

#### Именование переменных.

Для констант мы используем `UPPER_CASE` вместо `kConstantName`.

#### Область видимости

1. **Пространства имен**: директива `using namespace` разрешена в `.cc` файлах в ограниченных случаях, когда это значительно сокращает объем кода.
    1. Плюсы: уменьшает объем кода, снижает необходимость частых изменений в директивах `using namespace::class`.
    2. Минусы: загрязняет пространство имен, вызывает конфликты, усложняет определение типа объекта.

### Форматирование

Файл `.clang-format`, который хранится в репозитории Impala, следует использовать для форматирования пробелов. Файл `.clang-format` является основным источником для форматирования пробелов, за исключением случаев, когда его результат существенно отличается от практик в существующем коде или от здравого смысла. В таких случаях  
`.clang-format` следует обновить. Мы стремимся постепенно адаптировать кодовую базу к выводу clang-format, поэтому рекомендуем использовать его только на строках с изменениями, не связанными с пробелами. Это можно сделать с помощью инструмента `git-clang-format`.

Вы можете использовать `clang-format` или `clang-format-diff` для форматирования пробелов в C++ частях вашего патча, используя файл `.clang-format`, включенный в репозиторий git, который настроен таким образом, чтобы максимально соответствовать нашему текущему стилю кодирования. При подаче патча, отформатированного с помощью `clang-format`, пожалуйста, не переформатируйте весь файл, над которым вы работаете, а только те части, которые вы изменяете.

Некоторые ключевые отличия от стиля C++ Google:

1. **Длина строки**: мы используем длину строки в 90 символов.
2. **Объявление функций**: мы переносим строки иначе, чем Google, обычно размещая больше параметров в одной строке, например:  
    
    ```cpp
    // Google Recommends:
    ReturnType LongClassName::ReallyReallyReallyLongFunctionName(
        Type par_name1,  // 4 space indent
        Type par_name2,
        Type par_name3) {
      DoSomething();  // 2 space indent
      ...
    }
    // we use:
    ReturnType LongClassName::ReallyReallyReallyLongFunctionName(
        Type par_name1, Type par_name2, Type par_name3) { // 4 space indent
      DoSomething();  // 2 space indent
      ...
    }
    ```
    
3. **Условные операторы**: мы форматируем условные операторы следующим образом:  
    
    `// Google Recommends:`  
    `if` `(x == kFoo)` `return` `new` `Foo();`  
    `if` `(condition)`  
      `DoSomething();`  `// 2 space indent.`  
    `if` `(condition) {`  
      `DoSomething();`  `// 2 space indent.`  
    `}`  
    `// we only use:`  
    `if` `(x == kFoo)` `return` `new` `Foo();`  `// If the whole line fits into the 90 character limit`  
    `if` `(condition) {`  
      `DoSomething();`  `// Otherwise, 2 space indent.`  
    `}`
    

### Переформатирование

Вы можете использовать `clang-format` для автоматического форматирования только тех частей кода, которые вы изменили. См. [clang-format](https://clang.llvm.org/docs/ClangFormat.html#script-for-patch-reformatting) документацию. Файл `clang-format` для Impala находится по пути `${IMPALA_HOME}/.clang-format`. Команда `clang-*` использует этот файл для форматирования.

Чтобы переформатировать код вокруг строк, которые были изменены в вашем последнем коммите, выполните команду:

  

|   |
|---|
|`git diff -U0 --no-color HEAD^ \|` `"${IMPALA_TOOLCHAIN_PACKAGES_HOME}/llvm-${IMPALA_LLVM_VERSION}/share/clang/clang-format-diff.py"` `-binary` `"${IMPALA_TOOLCHAIN_PACKAGES_HOME}/llvm-${IMPALA_LLVM_VERSION}/bin/clang-format"` `-p1 -i`|

Опция `-i` означает замену "на месте". Запустите команду без этой опции, если хотите сначала увидеть различия перед применением изменений.

  

Если приведенный выше подход не работает или если вам нужно использовать другую версию, вы можете воспользоваться системной версией `clang-tidy`. На Ubuntu это можно сделать так:

`sudo apt-get install clang-format-``3.9`  
`git diff -U0 --no-color HEAD^ | clang-format-diff-``3.9` `-p1 -i`

### `Tidy Code`

Для проверки кода на потенциальные ошибки и "аккуратность" можно использовать `clang tidy:`

|                                                                                                                                                                                                                                                 |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `git diff asf-gerrit/master \|` `"${IMPALA_TOOLCHAIN_PACKAGES_HOME}/llvm-${IMPALA_LLVM_VERSION}/share/clang/clang-tidy-diff.py"` `-clang-tidy-binary` `"${IMPALA_TOOLCHAIN_PACKAGES_HOME}/llvm-${IMPALA_LLVM_VERSION}/bin/clang-tidy"` `-p` `1` |