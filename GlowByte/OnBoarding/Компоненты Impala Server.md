Сервер Impala является распределенным движком баз данных с массовой параллельной обработкой (MPP). Он состоит из различных демонов, которые работают на определенных узлах вашего кластера.

# ==Демон Impala==  

Основным компонентом Impala является демон Impala, физически представленный процессом `impalad`. Вот некоторые ключевые функции, которые выполняет демон Impala:

1. **Чтение и запись данных**: Демон обрабатывает операции чтения и записи в файлы данных.
2. **Прием запросов**: Он принимает запросы, передаваемые через командную строку `impala-shell`, Hue, JDBC или ODBC.
3. **Параллелизация запросов**: Демон параллелизует запросы и распределяет работу по кластеру, что позволяет эффективно использовать ресурсы.
4. **Передача промежуточных результатов**: Он передает промежуточные результаты запросов обратно к центральному координатору.
### Способы развертывания демонов Impala:
1. **Совместное размещение с HDFS**: Демоны Impala могут работать на том же хосте, что и DataNode HDFS, обеспечивая более быструю работу с данными.
2. **Отдельное развертывание**: Impala может быть развернута отдельно в вычислительном кластере, при этом она читает данные удаленно из HDFS, S3, ADLS и других систем.
### Взаимодействие с другими компонентами:
- Демоны Impala постоянно общаются с **StateStore**, чтобы подтвердить, какие демоны работают исправно и могут принимать новые задания.
- Они также получают сообщения от демона **catalogd** (введенного в Impala 1.2) о любых изменениях, связанных с объектами Impala, такими как создание, изменение или удаление объектов, а также при выполнении операторов `INSERT` или `LOAD DATA`. Это фоновое взаимодействие снижает необходимость в выполнении операторов `REFRESH` или `INVALIDATE METADATA`, которые требовались для синхронизации метаданных между демонами Impala до версии 1.2.
### Контроль координаторов запросов:
В Impala 2.9 и более поздних версиях вы можете управлять тем, какие узлы будут выступать в роли координаторов запросов, а какие — в роли исполнителей запросов, что улучшает масштабируемость для высоких нагрузок на больших кластерах. Для получения дополнительных сведений см. раздел "Как настроить Impala с выделенными координаторами".

Таким образом, демон Impala играет ключевую роль в обработке запросов и взаимодействии с другими компонентами, обеспечивая высокую производительность и эффективность работы с данными.

# ==Impala StateStore==

Компонент Impala, известный как StateStore, проверяет состояние всех демонов Impala в кластере и непрерывно передает свои выводы каждому из этих демонов. Он физически представлен демоном с именем `statestored`. Для работы такого процесса требуется только один экземпляр на хосте в кластере.
### Основные функции StateStore:
1. **Мониторинг состояния демонов**: StateStore отслеживает здоровье всех демонов Impala. Если какой-либо демон выходит из строя из-за аппаратной неисправности, сетевой ошибки, проблемы с программным обеспечением или другой причины, StateStore информирует остальные демоны Impala, чтобы будущие запросы избегали обращения к недоступному демону.
2. **Передача метаданных**: StateStore помогает передавать метаданные координаторам, что необходимо для их корректной работы.
### Роль в работе кластера:
- **Непривязка к нормальной работе**: StateStore не всегда критически важен для нормальной работы кластера Impala. Если StateStore не работает или становится недоступным, демоны Impala продолжают функционировать и распределять задачи между собой, используя известные метаданные. Однако, если другие демоны Impala выйдут из строя, кластер станет менее надежным, а метаданные будут менее согласованными, поскольку они могут изменяться, пока StateStore не будет доступен.
- **Восстановление**: Когда StateStore возвращается в онлайн, он восстанавливает связь с демонами Impala и возобновляет свои функции мониторинга и передачи данных.
### Влияние на операции:
- Если вы выполните оператор DDL (Data Definition Language), когда StateStore отключен, запросы, обращающиеся к новому объекту, созданному оператором DDL, завершатся с ошибкой.
### Высокая доступность и балансировка нагрузки:
- Большинство соображений по балансировке нагрузки и высокой доступности применяются к демону `impalad`. Демоны `statestored` и `catalogd` не имеют особых требований к высокой доступности, поскольку проблемы с этими демонами не приводят к потере данных. Если эти демоны становятся недоступными из-за сбоя на определенном хосте, вы можете остановить сервис Impala, удалить роли Impala StateStore и Impala Catalog Server, добавить роли на другом хосте и перезапустить сервис Impala.

Таким образом, StateStore играет важную, но не критическую роль в поддержании здоровья и согласованности демонов Impala, позволяя кластеру функционировать даже в случае некоторых сбоев.

# ==Impala Catalog Service==

Компонент Impala, известный как Catalog Service, передает изменения метаданных от SQL-запросов Impala ко всем координаторам Impala в кластере. Он физически представлен демоном с именем `catalogd`. Для работы такого процесса требуется только один экземпляр на хосте в кластере. Поскольку запросы передаются через демон StateStore, разумно запускать службы `statestored` и `catalogd` на одном хосте.
### Основные функции службы каталогов:
1. **Передача изменений метаданных**: Служба каталогов избегает необходимости вручную выдавать команды `REFRESH` и `INVALIDATE METADATA`, когда изменения метаданных выполняются с помощью SQL-запросов Impala.
2. **Обработка операций**: Когда вы создаете таблицу, загружаете данные и т. д. через Hive, вам необходимо выполнить команду `REFRESH` или `INVALIDATE METADATA` на демоне Impala перед выполнением запроса. Однако, если автоматическая недействительность/обновление метаданных включена, выполнять эти команды не требуется. Начиная с Impala 4.1, автоматическая недействительность/обновление метаданных включена по умолчанию.
### Высокая доступность и балансировка нагрузки:
- Большинство соображений по балансировке нагрузки и высокой доступности применяются к демону `impalad`. Демоны `statestored` и `catalogd` не имеют особых требований к высокой доступности, поскольку проблемы с этими демонами не приводят к потере данных. Если эти демоны становятся недоступными из-за сбоя на определенном хосте, вы можете остановить сервис Impala, удалить роли Impala StateStore и Impala Catalog Server, добавить роли на другом хосте и перезапустить сервис Impala.

Служба каталогов играет важную роль в управлении метаданными в Impala, позволяя улучшить производительность и согласованность запросов без необходимости ручного управления метаданными.

# ==Coordinator/Executor узлы кластера Impala==

В Impala, **координатор (Coordinator)** и **исполнитель (Executor)** — это роли, которые выполняют разные функции в процессе обработки SQL-запросов:
### Coordinator
- **Роль**: Координатор отвечает за планирование и распределение задач для выполнения. Он получает SQL-запросы от клиентов и анализирует их, чтобы определить, как наиболее эффективно выполнить запрос.
- **Функции**:
  - Разрабатывает план выполнения запроса.
  - Определяет, какие данные необходимо извлечь, и как их обработать.
  - Распределяет задачи среди исполнителей в кластере.
  - Собирает результаты выполнения запросов и отправляет их обратно клиентам.
### Executor
- **Роль**: Исполнитель отвечает за фактическое выполнение запросов и выполнение задач, которые были распределены координатором.
- **Функции**:
  - Обрабатывает полученные задачи, выполняет вычисления и операции с данными.
  - Считывает данные из хранилищ (например, HDFS или HBase) и выполняет операции обработки (например, фильтрацию, агрегацию).
  - Возвращает промежуточные результаты координатору для дальнейшей обработки.
### Работа в паре
- В архитектуре Impala каждый узел в кластере может выполнять одну из этих ролей или обе, в зависимости от конфигурации и загруженности системы. Это позволяет эффективно масштабировать запросы и использовать ресурсы кластера.
- В версиях Impala 2.9 и выше появилась возможность более гибко управлять распределением ролей, что улучшает масштабируемость для высоких нагрузок и параллельного выполнения запросов.

Таким образом, координатор и исполнитель работают вместе для обработки запросов, что позволяет Impala обеспечивать высокую производительность и эффективность при работе с большими объемами данных.