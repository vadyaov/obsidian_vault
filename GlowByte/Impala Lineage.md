Функция отслеживания происхождения данных (lineage) помогает определить, откуда поступили данные и как они распространяются по системе с помощью SQL-команд, таких как `SELECT`, `INSERT` и `CREATE TABLE AS SELECT`.

Такой вид отслеживания особенно важен в условиях высокой безопасности, особенно в отраслях с жестким регулированием, таких как здравоохранение, фармацевтика, финансовые услуги и разведка. Для таких типов конфиденциальных данных важно знать все места в системе, содержащие эти данные или производные от них; проверять, кто имел доступ к этим данным; и иметь возможность перепроверить, что данные, использованные для принятия решений, были обработаны корректно и не подверглись изменениям.

### Происхождение данных на уровне колонок

Происхождение данных на уровне колонок позволяет отслеживать информацию более детально — на уровне отдельных колонок, а не целых таблиц.

Например, если у вас есть таблица с данными, полученными из веб-логов, эти данные могут копироваться в другие таблицы в рамках процесса ETL. ETL-операции могут включать преобразования с использованием выражений и вызовов функций, а также перестановку колонок с разбиением данных на большее или меньшее количество таблиц (нормализация или денормализация данных). Далее, для создания отчетов могут выполняться запросы к нескольким таблицам и представлениям. В этом примере происхождение данных на уровне колонок позволяет определить, что данные, поступившие в систему как `RAW_LOGS.FIELD1`, затем были преобразованы в `WEBSITE_REPORTS.IP_ADDRESS` через команду `INSERT ... SELECT`. Или, наоборот, вы можете начать с запроса на отчет по представлению и проследить происхождение данных в поле, таком как `TOP_10_VISITORS.USER_ID`, вернувшись к исходной таблице и даже к моменту, когда данные впервые загрузились в Impala.

Если у вас есть таблицы, где необходимо отслеживать или ограничивать доступ к конфиденциальной информации на уровне колонок, обратитесь к разделу об [авторизации в Impala](https://impala.apache.org/docs/build/html/topics/impala_authorization.html#authorization) для реализации безопасности на уровне колонок. Вы можете настроить авторизацию с помощью фреймворка Ranger, создать представления, которые ссылаются на определенные наборы колонок, и затем назначить привилегии доступа к этим представлениям, а не к базовым таблицам.

### Данные о происхождении для Impala

Функция отслеживания происхождения данных (lineage) включена по умолчанию. При активном журналировании происхождения вычисляется сериализованный граф lineage для каждой колонки в запросе, и результаты сохраняются в специализированном журнале в формате JSON.

Impala записывает запросы в журнал происхождения данных, если они успешно завершились или завершились с ошибкой авторизации. Для операций записи, таких как `INSERT` и `CREATE TABLE AS SELECT`, запись появляется в журнале происхождения только в случае успешного выполнения. Таким образом, функция lineage отслеживает данные, к которым был доступ через успешные запросы, или попытки доступа через неуспешные запросы, заблокированные из-за ошибки авторизации. Эти запросы представляют данные, к которым действительно был доступ, или попытки доступа, которые могут свидетельствовать о вредоносной активности.

Impala не записывает в журнал происхождения запросы, завершившиеся ошибкой синтаксиса, или запросы, которые прерваны или отменены до этапа выборки строк из результирующего набора.

Чтобы включить или отключить эту функцию, настройте или удалите параметр конфигурации `-lineage_event_log_dir` для демона `impalad`.

## Параметры ведения журнала lineage для Impala

1. `max_lineage_log_file_size`
   - Тип: `int32`
   - Значение по умолчанию: `5000`
   - Описание: Определяет максимальный размер файла журнала lineage (в количестве запросов), после которого создается новый файл журнала. Этот параметр действует только при включенном ведении журнала lineage.

2. `lineage_event_log_dir`
   - Тип: `string`
   - Значение по умолчанию: пустая строка (`""`)
   - Описание: Указывает директорию, в которую записываются файлы журнала событий lineage. Установка этого параметра автоматически включает ведение журнала lineage.

3. `abort_on_failed_lineage_event`
   - Тип: `bool`
   - Значение по умолчанию: `true`
   - Описание: Определяет поведение Impala при возникновении ошибки записи записи lineage. Если параметр установлен в `true`, Impala завершает работу в случае возникновения проблемы с записью события lineage.

4. `max_lineage_log_files`
   - Тип: `int32`
   - Значение по умолчанию: `10`
   - Описание: Определяет максимальное количество файлов журнала lineage, которые сохраняются. Хранятся только самые последние файлы. Если параметр установлен в `0`, сохраняются все файлы журнала lineage