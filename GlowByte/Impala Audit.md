Чтобы отслеживать, как данные Impala используются в вашей организации, убедитесь, что ваши политики авторизации и аутентификации Impala эффективны. Чтобы обнаруживать попытки вторжения или несанкционированного доступа к данным Impala, вы можете использовать функцию аудита, доступную в Impala версии 1.2.1 и выше.
- Включите аудит, добавив опцию `‑‑audit_event_log_dir=путь_к_каталогу` в параметры запуска impalad. Директория для журналов должна быть локальной на сервере, а не HDFS-директорией.
- Определите, сколько запросов будет отображаться в каждом файле журнала аудита. По умолчанию Impala создает новый файл журнала событий аудита каждые 5000 запросов. Чтобы указать другое количество, добавьте опцию `‑‑max_audit_event_log_file_size=число_запросов` в параметры запуска impalad.
- В Impala версии 2.9 и выше можно управлять количеством файлов журнала событий аудита, сохраняемых на каждом хосте. Укажите опцию `‑‑max_audit_event_log_files=число_файлов` в параметрах запуска impalad. Как только лимит будет достигнут, более старые файлы будут заменены аналогично другим файлам журналов Impala. Значение по умолчанию для этого параметра — 0, что означает неограниченное количество файлов журнала аудита.
- Используйте диспетчер кластера с функциями управления для фильтрации, визуализации и создания отчетов на основе журналов аудита, собранных со всех хостов в кластере.

### Соображения по надежности и производительности для аудита Impala

Функция аудита влияет на производительность только при включенном аудите.

Поскольку любой узел Impala может обрабатывать запрос, включите аудит на всех хостах, где запущен демон impalad. Каждый узел сохраняет свои журналы в локальной файловой системе. Данные журнала периодически сбрасываются на диск (с помощью системного вызова `fsync()`), чтобы избежать потери данных аудита в случае сбоя.

Нагрузка на производительность от аудита приходится на тот узел, который выполняет роль координатора для запроса, то есть на тот, к которому вы подключаетесь при отправке запроса. Это может быть один и тот же узел для всех запросов или разные узлы, если пользователи или приложения подключаются и отправляют запросы через разные хосты.

Чтобы избежать избыточной нагрузки на ввод-вывод на занятых узлах-координаторах, Impala синхронизирует данные аудита (используя вызов `fsync()`) периодически, а не после каждого запроса. В настоящее время вызовы `fsync()` выполняются через фиксированные интервалы, каждые 5 секунд.

По умолчанию Impala предотвращает потерю данных аудита в случае ошибки записи (например, при переполнении диска), немедленно останавливая impalad на хосте, где произошла ошибка аудита. Вы можете изменить это поведение, указав опцию `‑‑abort_on_failed_audit_event=false` в параметрах запуска impalad.

### Формат файлов журнала аудита

Файлы журнала аудита представляют информацию о запросах в формате JSON, по одному запросу на строку. Обычно вместо того, чтобы просматривать сами журналы, следует использовать программное обеспечение для управления кластером для объединения данных журналов со всех узлов Impala, а также для фильтрации и визуализации результатов в удобных форматах. (Если вам нужно просмотреть необработанные данные журнала, можно сначала пропустить их через JSON pretty-printer для удобства.)

Вся информация о схеме объектов, к которым выполняется доступ в запросе, закодирована в одной вложенной записи на той же строке. Например, в журнале аудита для команды `INSERT ... SELECT` фиксируется, что операция выбора выполняется для исходной таблицы, а операция вставки — для целевой таблицы. В журнале аудита для запроса к представлению фиксируются базовые таблицы, к которым обращается представление, или несколько базовых таблиц в случае представления, содержащего запрос с объединением. Каждая операция Impala, соответствующая SQL-запросу, записывается в журнал аудита, независимо от того, завершилась она успешно или нет. Для успешной операции записывается больше информации, чем для неуспешной, так как неавторизованный запрос прерывается немедленно, до завершения планирования запроса.

### Данные, записываемые для каждого запроса

Записываемая информация включает:

- **Состояние клиентской сессии:**
  - Идентификатор сессии
  - Имя пользователя
  - Сетевой адрес клиентского подключения

- **Детали SQL-запроса:**
  - Идентификатор запроса
  - Тип команды — DML, DDL и так далее
  - Текст SQL-запроса
  - Время начала выполнения в локальном времени
  - Статус выполнения — подробности об ошибках, если они возникли

- **Целевые объекты каталога:**
  - Тип объекта — таблица, представление или база данных
  - Полностью квалифицированное имя объекта
  - Привилегия — способ использования объекта (SELECT, INSERT, CREATE и так далее)

### Какие операции фиксируются в аудите

В журнал аудита записываются следующие типы SQL-операций:

- Запросы, отклоненные из-за отсутствия авторизации.
- Запросы, которые Impala может проанализировать и распарсить для определения, что они авторизованы. Данные аудита записываются сразу после завершения анализа Impala, до фактического выполнения запроса.
- Запросы, результаты которых доступны для извлечения клиентами.
- Завершенные DDL-операции.

Журнал аудита не содержит записей о запросах, которые не удалось распарсить и проанализировать. Например, запрос, завершившийся ошибкой из-за синтаксической ошибки, не будет записан в журнал аудита.

Журнал аудита также не включает запросы, которые не выполняются из-за ссылки на несуществующую таблицу.

Некоторые команды в интерпретаторе `impala-shell`, такие как `CONNECT`, `SUMMARY`, `PROFILE`, `SET` и `QUIT`, не соответствуют реальным SQL-запросам, и они не записываются в журнал аудита.

## Параметры аудита для Impala

1. `max_audit_event_log_file_size`
   - Тип: `int32`
   - Значение по умолчанию: `5000`
   - Описание: Определяет максимальный размер файла журнала аудита (в количестве запросов), после которого создается новый файл журнала. Этот параметр действует только при включенном аудите.

2. `audit_event_log_dir`
   - Тип: `string`
   - Значение по умолчанию: пустая строка (`""`)
   - Описание: Указывает директорию, в которую записываются файлы журнала событий аудита. Установка этого параметра автоматически включает ведение журнала аудита.

3. `abort_on_failed_audit_event`
   - Тип: `bool`
   - Значение по умолчанию: `true`
   - Описание: Определяет поведение Impala при возникновении ошибки записи события аудита. Если параметр установлен в `true`, Impala завершает работу в случае возникновения проблемы с записью события аудита.

4. `max_audit_event_log_files`
   - Тип: `int32`
   - Значение по умолчанию: `0`
   - Описание: Определяет максимальное количество файлов журнала аудита, которые сохраняются. Хранятся только самые последние файлы. Если параметр установлен в `0`, сохраняются все файлы журнала аудита.

